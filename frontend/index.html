<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veritas | Misinformation Detector MVP</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gauge-bg { stroke: #e5e7eb; }
        .gauge-fill { transition: stroke-dashoffset 1s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- CONFIGURATION ---
        // In production, this matches your Railway URL
        const API_BASE_URL = "http://localhost:8000"; 

        const Gauge = ({ score }) => {
            // Safety check for score
            const safeScore = isNaN(score) ? 0 : score;
            
            const radius = 50;
            const stroke = 8;
            const normalizedRadius = radius - stroke * 2;
            const circumference = normalizedRadius * 2 * Math.PI;
            const strokeDashoffset = circumference - (safeScore / 100) * circumference;
            
            let color = "text-green-500";
            if (safeScore < 40) color = "text-red-500";
            else if (safeScore < 70) color = "text-yellow-500";

            return (
                <div className="relative flex items-center justify-center">
                    <svg height={radius * 2} width={radius * 2} className="rotate-[-90deg]">
                        <circle
                            className="stroke-slate-200"
                            strokeWidth={stroke}
                            fill="transparent"
                            r={normalizedRadius}
                            cx={radius}
                            cy={radius}
                        />
                        <circle
                            className={`${color} transition-all duration-1000 ease-out`}
                            strokeWidth={stroke}
                            strokeDasharray={circumference + ' ' + circumference}
                            style={{ strokeDashoffset }}
                            strokeLinecap="round"
                            fill="transparent"
                            r={normalizedRadius}
                            cx={radius}
                            cy={radius}
                        />
                    </svg>
                    <div className="absolute text-center">
                        <span className={`text-2xl font-bold ${color}`}>{safeScore.toFixed(0)}%</span>
                        <div className="text-[10px] text-slate-500 uppercase tracking-wider">Credible</div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [file, setFile] = useState(null);
            const [status, setStatus] = useState("idle"); // idle, uploading, analyzing, done, error
            const [result, setResult] = useState(null);
            const [errorMsg, setErrorMsg] = useState("");

            const handleFileChange = (e) => {
                if (e.target.files && e.target.files[0]) {
                    setFile(e.target.files[0]);
                    setStatus("idle");
                    setResult(null);
                    setErrorMsg("");
                }
            };

            const processUpload = async () => {
                if (!file) return;
                
                try {
                    setStatus("uploading");
                    setErrorMsg(""); // Clear previous errors
                    
                    // 1. Get Presigned URL
                    const urlRes = await fetch(`${API_BASE_URL}/generate-upload-url?file_type=${file.type}&extension=${file.name.split('.').pop()}`);
                    if (!urlRes.ok) throw new Error("Failed to get upload URL. Is backend running?");
                    const { upload_url, file_key } = await urlRes.json();

                    // 2. Upload to S3
                    const uploadRes = await fetch(upload_url, {
                        method: "PUT",
                        body: file,
                        headers: { "Content-Type": file.type }
                    });
                    if (!uploadRes.ok) throw new Error("S3 Upload Failed");

                    // 3. Trigger Analysis
                    setStatus("analyzing");
                    const analyzeRes = await fetch(`${API_BASE_URL}/analyze`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ 
                            file_key: file_key,
                            file_type: file.type
                        })
                    });
                    
                    if (!analyzeRes.ok) throw new Error("Analysis Failed");
                    const data = await analyzeRes.json();
                    
                    // --- IMPROVED ERROR HANDLING ---
                    // Detect if the backend returned a logical error even with 200 OK
                    if (data.status === "error") throw new Error(data.message);
                    if (data.error) throw new Error(data.error); 
                    
                    setResult(data);
                    setStatus("done");

                } catch (err) {
                    console.error("Upload Logic Error:", err);
                    setErrorMsg(err.message || "An unexpected error occurred");
                    setStatus("error");
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden">
                        
                        {/* Header */}
                        <div className="bg-slate-900 p-6 text-center">
                            <h1 className="text-2xl font-bold text-white tracking-tight">Veritas AI</h1>
                            <p className="text-slate-400 text-sm mt-1">Deepfake & Misinformation Detector</p>
                        </div>

                        {/* Content */}
                        <div className="p-6 space-y-6">
                            
                            {/* Upload Area */}
                            <div className={`border-2 border-dashed rounded-xl p-8 text-center transition-colors ${file ? 'border-blue-500 bg-blue-50' : 'border-slate-200 hover:border-slate-400'}`}>
                                <input 
                                    type="file" 
                                    id="fileInput" 
                                    className="hidden" 
                                    accept="image/*,video/*"
                                    onChange={handleFileChange}
                                />
                                <label htmlFor="fileInput" className="cursor-pointer flex flex-col items-center gap-2">
                                    <div className="p-3 bg-slate-100 rounded-full text-slate-600">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                                    </div>
                                    <span className="text-sm font-medium text-slate-700">
                                        {file ? file.name : "Click to upload Image or Video"}
                                    </span>
                                    <span className="text-xs text-slate-400">Supported: MP4, JPG, PNG</span>
                                </label>
                            </div>

                            {/* Action Button */}
                            {file && status !== "done" && status !== "analyzing" && (
                                <button 
                                    onClick={processUpload}
                                    disabled={status === "uploading"}
                                    className="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition-all flex items-center justify-center gap-2"
                                >
                                    {status === "uploading" ? "Uploading..." : "Analyze Media"}
                                </button>
                            )}

                            {/* Loading State */}
                            {status === "analyzing" && (
                                <div className="text-center py-4 space-y-3 animate-pulse">
                                    <div className="h-2 bg-slate-200 rounded-full overflow-hidden">
                                        <div className="h-full bg-blue-500 w-2/3 animate-[shimmer_1s_infinite]"></div>
                                    </div>
                                    <p className="text-sm text-slate-500">Running AI Inference on Modal Cloud...</p>
                                </div>
                            )}

                            {/* Error State */}
                            {status === "error" && (
                                <div className="p-4 bg-red-50 text-red-700 rounded-lg text-sm border border-red-100 flex flex-col gap-1">
                                    <strong>Error Detected:</strong> 
                                    <span>{errorMsg}</span>
                                </div>
                            )}

                            {/* Results */}
                            {status === "done" && result && (
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                                    <div className="flex items-center justify-between bg-slate-50 p-4 rounded-xl border border-slate-100">
                                        <div>
                                            <p className="text-sm text-slate-500 font-medium">Verdict</p>
                                            <h3 className={`text-xl font-bold ${result.score > 50 ? 'text-green-600' : 'text-red-600'}`}>
                                                {result.verdict}
                                            </h3>
                                        </div>
                                        <Gauge score={result.score} />
                                    </div>
                                    
                                    <div className="mt-4">
                                        <h4 className="text-sm font-semibold text-slate-800 mb-2">Analysis Details</h4>
                                        <ul className="space-y-2">
                                            {/* DEFENSIVE RENDERING: Check if details exists and is an array */}
                                            {result.details && Array.isArray(result.details) && result.details.length > 0 ? (
                                                result.details.map((detail, idx) => (
                                                    <li key={idx} className="text-sm text-slate-600 flex items-start gap-2">
                                                        <span className="mt-1 block w-1.5 h-1.5 rounded-full bg-blue-400 shrink-0"></span>
                                                        {detail}
                                                    </li>
                                                ))
                                            ) : (
                                                <li className="text-sm text-slate-500 italic">No specific details available.</li>
                                            )}
                                        </ul>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>